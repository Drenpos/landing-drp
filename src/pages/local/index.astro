---
import BlogCard from "@/components/BlogCard.astro";
import ImageMod from "@/components/ImageMod.astro";
import Pagination from "@/components/Pagination.astro";
import config from "@/config/config.json";
import DynamicIcon from "@/helpers/DynamicIcon";
import Base from "@/layouts/Base.astro";
import { getSinglePage } from "@/lib/contentParser.astro";
import dateFormat from "@/lib/utils/dateFormat";
import { sortByDate } from "@/lib/utils/sortFunctions";
import { markdownify } from "@/lib/utils/textConverter";
import PageHeader from "@/partials/PageHeader.astro";
import type { CollectionEntry } from "astro:content";
import { getEntry } from "astro:content";

const BLOG_FOLDER = "local";

const postIndex = (await getEntry(
  BLOG_FOLDER,
  "-index",
)) as CollectionEntry<"local">;
const posts = await getSinglePage(BLOG_FOLDER);
const sortedPosts = sortByDate(posts);
const totalPages: number = Math.ceil(posts.length / config.settings.pagination);
const currentPosts = sortedPosts.slice(0, config.settings.pagination);

const featuredPost = posts.filter((post) => post.data.featured).slice(0, 1);
---

<Base
  title={postIndex.data.title}
  meta_title={postIndex.data.meta_title}
  image={postIndex.data.image}
  description={postIndex.data.description}
>
  <PageHeader
    title={postIndex.data.hero?.title}
    description={postIndex.data.hero?.description}
  />

  <section class="section-up">
    <div class="container">
      <div class="row justify-center">
        <div class="col-10">
          {
            featuredPost.map((post) => (
              <div
                class="rounded-[32px] border border-dark/10 p-5 bg-body"
                data-aos="fade-up-sm"
                data-aos-delay="200"
              >
                <div class="row">
                  <div class="md:col-6">
                    <div class="relative group overflow-hidden rounded-[20px]">
                      <ImageMod
                        src={post.data.image!}
                        alt={post.data.title}
                        width={500}
                        height={460}
                        class="object-cover rounded-[20px] w-full group-hover:scale-110 transition duration-700"
                      />
                    </div>
                  </div>

                  <div class="md:col-6">
                    {post.data.date && (
                      <p class="text-text-dark text-sm">
                        {dateFormat(`${post.data.date}`)}
                      </p>
                    )}

                    {post.data.title && (
                      <h2
                        class="h3 my-6"
                        set:html={markdownify(post.data.title)}
                      />
                    )}
                    {post.body && (
                      <div
                        class="line-clamp-3"
                        set:html={markdownify(post.body, true)}
                      />
                    )}

                    <a
                      class="btn btn-dark mt-14"
                      href={`/${BLOG_FOLDER}/${post.id.replace(".md", "")}`}
                      rel="noopener"
                      data-aos="fade-up-sm"
                      data-aos-delay="200"
                    >
                      {"Leer Más"}
                      <span class="icon-wrapper">
                        <span class="icon">
                          <DynamicIcon icon={"FaArrowRight"} />
                        </span>
                        <span class="icon" aria-hidden="true">
                          <DynamicIcon icon={"FaArrowRight"} />
                        </span>
                      </span>
                    </a>
                  </div>
                </div>
              </div>
            ))
          }
        </div>
      </div>
    </div>
  </section>

  <section class="section pt-0" data-aos="fade-up-sm">
    <div class="container">
      <h2 class="text-center mb-14">Nuestras Últimas Publicaciones</h2>
      <div class="row gx-5 justify-center">
        <!-- blog posts -->
        <div class="lg:col-10">
          <div class="row">
            {
              currentPosts.map((post, i) => (
                <div
                  class="mb-14 md:col-6"
                  data-aos="fade-up-sm"
                  data-aos-delay={i * 100}
                >
                  <BlogCard data={post} />
                </div>
              ))
            }
          </div>
          <Pagination
            section={BLOG_FOLDER}
            currentPage={1}
            totalPages={totalPages}
          />
        </div>
      </div>
    </div>
  </section>
</Base>
